<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Keys Setup - Multi-Agent QA System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .setup-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .provider-card {
            transition: all 0.3s ease;
            border: 2px solid #e9ecef;
        }
        
        .provider-card.selected {
            border-color: #0d6efd;
            background-color: #f8f9ff;
        }
        
        .key-input-group {
            position: relative;
        }
        
        .key-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #6c757d;
        }
        
        .test-result {
            margin-top: 10px;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .test-result.valid {
            background-color: #d1edff;
            color: #0c5460;
            border: 1px solid #b8daff;
        }
        
        .test-result.invalid {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .feature-list {
            list-style: none;
            padding-left: 0;
        }
        
        .feature-list li {
            padding: 4px 0;
        }
        
        .feature-list li::before {
            content: "âœ“";
            color: #28a745;
            font-weight: bold;
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-robot me-2"></i>Multi-Agent QA System
            </a>
            <div class="navbar-nav">
                <a class="nav-link" href="/"><i class="fas fa-tachometer-alt me-1"></i>Dashboard</a>
                <a class="nav-link active" href="/setup"><i class="fas fa-cog me-1"></i>Setup</a>
                <a class="nav-link" href="/execute"><i class="fas fa-play me-1"></i>Execute</a>
                <a class="nav-link" href="/history"><i class="fas fa-history me-1"></i>History</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="setup-container">
            <div class="text-center mb-5">
                <h1><i class="fas fa-key me-2"></i>API Keys Setup</h1>
                <p class="text-muted">Configure your LLM provider API keys to enable the multi-agent system</p>
            </div>

            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Important:</strong> You need at least one API key to run the system. 
                The system can work with mock agents for development, but real LLM providers 
                are required for production testing.
            </div>

            <form id="setupForm">
                <!-- OpenAI Configuration -->
                <div class="card provider-card mb-4" id="openai-card">
                    <div class="card-header">
                        <div class="row align-items-center">
                            <div class="col">
                                <h5 class="mb-0">
                                    <i class="fab fa-openai me-2"></i>OpenAI GPT
                                    <span class="badge bg-primary ms-2">Recommended</span>
                                </h5>
                            </div>
                            <div class="col-auto">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="openai-enable" onchange="toggleProvider('openai')">
                                    <label class="form-check-label" for="openai-enable">Enable</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body" id="openai-body" style="display: none;">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="openai-key" class="form-label">API Key</label>
                                    <div class="key-input-group">
                                        <input type="password" class="form-control" id="openai-key" 
                                               placeholder="sk-... or github_pat_... or ghp_..." 
                                               value="{{ api_keys.openai if api_keys and api_keys.openai else '' }}"
                                               onchange="validateKey('openai')">
                                        <i class="fas fa-eye key-toggle" onclick="toggleKeyVisibility('openai-key', this)"></i>
                                    </div>
                                    <div class="form-text">
                                        <strong>OpenAI:</strong> Get API key from <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI Platform</a><br>
                                        <strong>GitHub:</strong> Use your GitHub token for free OpenAI API access via <a href="https://github.com/marketplace/models" target="_blank">GitHub Models</a>
                                    </div>
                                    <div id="openai-test-result"></div>
                                </div>
                                <div class="mb-3">
                                    <label for="openai-model" class="form-label">Model</label>
                                    <select class="form-select" id="openai-model">
                                        <option value="gpt-4-turbo-preview">GPT-4 Turbo (Recommended)</option>
                                        <option value="gpt-4">GPT-4</option>
                                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                    </select>
                                </div>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="testKey('openai')">
                                    <i class="fas fa-vial me-1"></i>Test Connection
                                </button>
                            </div>
                            <div class="col-md-4">
                                <h6>Features:</h6>
                                <ul class="feature-list">
                                    <li>Best overall performance</li>
                                    <li>Excellent reasoning</li>
                                    <li>Fast response times</li>
                                    <li>Stable API</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Anthropic Configuration -->
                <div class="card provider-card mb-4" id="anthropic-card">
                    <div class="card-header">
                        <div class="row align-items-center">
                            <div class="col">
                                <h5 class="mb-0">
                                    <i class="fas fa-brain me-2"></i>Anthropic Claude
                                    <span class="badge bg-secondary ms-2">Alternative</span>
                                </h5>
                            </div>
                            <div class="col-auto">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="anthropic-enable" onchange="toggleProvider('anthropic')">
                                    <label class="form-check-label" for="anthropic-enable">Enable</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body" id="anthropic-body" style="display: none;">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="anthropic-key" class="form-label">API Key</label>
                                    <div class="key-input-group">
                                        <input type="password" class="form-control" id="anthropic-key" 
                                               placeholder="sk-ant-..." 
                                               value="{{ api_keys.anthropic if api_keys and api_keys.anthropic else '' }}"
                                               onchange="validateKey('anthropic')">
                                        <i class="fas fa-eye key-toggle" onclick="toggleKeyVisibility('anthropic-key', this)"></i>
                                    </div>
                                    <div class="form-text">
                                        Get your API key from <a href="https://console.anthropic.com/" target="_blank">Anthropic Console</a>
                                    </div>
                                    <div id="anthropic-test-result"></div>
                                </div>
                                <div class="mb-3">
                                    <label for="anthropic-model" class="form-label">Model</label>
                                    <select class="form-select" id="anthropic-model">
                                        <option value="claude-3-opus-20240229">Claude 3 Opus</option>
                                        <option value="claude-3-sonnet-20240229">Claude 3 Sonnet</option>
                                        <option value="claude-3-haiku-20240307">Claude 3 Haiku</option>
                                    </select>
                                </div>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="testKey('anthropic')">
                                    <i class="fas fa-vial me-1"></i>Test Connection
                                </button>
                            </div>
                            <div class="col-md-4">
                                <h6>Features:</h6>
                                <ul class="feature-list">
                                    <li>Great at analysis</li>
                                    <li>Detailed responses</li>
                                    <li>Good safety features</li>
                                    <li>Large context window</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Google Configuration -->
                <div class="card provider-card mb-4" id="google-card">
                    <div class="card-header">
                        <div class="row align-items-center">
                            <div class="col">
                                <h5 class="mb-0">
                                    <i class="fab fa-google me-2"></i>Google Gemini
                                    <span class="badge bg-info ms-2">Free Tier</span>
                                </h5>
                            </div>
                            <div class="col-auto">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="google-enable" onchange="toggleProvider('google')">
                                    <label class="form-check-label" for="google-enable">Enable</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body" id="google-body" style="display: none;">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="google-key" class="form-label">API Key</label>
                                    <div class="key-input-group">
                                        <input type="password" class="form-control" id="google-key" 
                                               placeholder="AIza..." 
                                               value="{{ api_keys.google if api_keys and api_keys.google else '' }}"
                                               onchange="validateKey('google')">
                                        <i class="fas fa-eye key-toggle" onclick="toggleKeyVisibility('google-key', this)"></i>
                                    </div>
                                    <div class="form-text">
                                        Get your API key from <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a>
                                    </div>
                                    <div id="google-test-result"></div>
                                </div>
                                <div class="mb-3">
                                    <label for="google-model" class="form-label">Model</label>
                                    <select class="form-select" id="google-model">
                                        <option value="gemini-1.5-flash">Gemini 1.5 Flash (Recommended - Free)</option>
                                        <option value="gemini-pro">Gemini Pro</option>
                                        <option value="gemini-pro-vision">Gemini Pro Vision</option>
                                    </select>
                                    <div class="form-text">
                                        <strong>Gemini Flash:</strong> Fast, free tier with high rate limits<br>
                                        <strong>Gemini Pro:</strong> More capable but requires billing
                                    </div>
                                </div>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="testKey('google')">
                                    <i class="fas fa-vial me-1"></i>Test Connection
                                </button>
                            </div>
                            <div class="col-md-4">
                                <h6>Features:</h6>
                                <ul class="feature-list">
                                    <li>Free tier available</li>
                                    <li>Good multimodal support</li>
                                    <li>Fast inference</li>
                                    <li>Vision capabilities</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mock Environment Option -->
                <div class="card border-warning mb-4">
                    <div class="card-header bg-warning bg-opacity-10">
                        <h5 class="mb-0">
                            <i class="fas fa-flask me-2"></i>Development Mode
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="use-mock" checked>
                            <label class="form-check-label" for="use-mock">
                                <strong>Use Mock Environment for Development</strong>
                            </label>
                        </div>
                        <div class="form-text">
                            Enable this to run the system without real API keys for testing and development. 
                            The system will use mock responses and environments.
                        </div>
                    </div>
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <button type="button" class="btn btn-outline-secondary" onclick="skipSetup()">
                        <i class="fas fa-forward me-1"></i>Skip (Use Mock)
                    </button>
                    <button type="submit" class="btn btn-primary" id="saveButton" disabled>
                        <i class="fas fa-save me-1"></i>Save Configuration
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let validKeys = {};
        
        function toggleProvider(provider) {
            const checkbox = document.getElementById(`${provider}-enable`);
            const body = document.getElementById(`${provider}-body`);
            const card = document.getElementById(`${provider}-card`);
            
            if (checkbox.checked) {
                body.style.display = 'block';
                card.classList.add('selected');
            } else {
                body.style.display = 'none';
                card.classList.remove('selected');
                validKeys[provider] = false;
            }
            
            updateSaveButton();
        }
        
        function toggleKeyVisibility(inputId, icon) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }
        
        function validateKey(provider) {
            const key = document.getElementById(`${provider}-key`).value;
            const isValid = key.length > 0;
            validKeys[provider] = isValid;
            updateSaveButton();
        }
        
        function testKey(provider) {
            const key = document.getElementById(`${provider}-key`).value;
            if (!key) {
                showTestResult(provider, 'Please enter an API key first', false);
                return;
            }
            
            const resultDiv = document.getElementById(`${provider}-test-result`);
            resultDiv.innerHTML = '<div class="text-info"><i class="fas fa-spinner fa-spin me-1"></i>Testing connection...</div>';
            
            const testData = {};
            testData[`${provider}_key`] = key;
            
            fetch('/api/test-keys', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(testData)
            })
            .then(response => response.json())
            .then(data => {
                const result = data[provider];
                if (result === 'valid') {
                    showTestResult(provider, 'Connection successful!', true);
                    validKeys[provider] = true;
                } else {
                    showTestResult(provider, result, false);
                    validKeys[provider] = false;
                }
                updateSaveButton();
            })
            .catch(error => {
                showTestResult(provider, `Test failed: ${error.message}`, false);
                validKeys[provider] = false;
                updateSaveButton();
            });
        }
        
        function showTestResult(provider, message, isValid) {
            const resultDiv = document.getElementById(`${provider}-test-result`);
            const className = isValid ? 'test-result valid' : 'test-result invalid';
            const icon = isValid ? 'fa-check-circle' : 'fa-exclamation-circle';
            
            resultDiv.innerHTML = `<div class="${className}"><i class="fas ${icon} me-1"></i>${message}</div>`;
        }
        
        function updateSaveButton() {
            const saveButton = document.getElementById('saveButton');
            const hasValidKey = Object.values(validKeys).some(valid => valid);
            const mockEnabled = document.getElementById('use-mock').checked;
            
            saveButton.disabled = !hasValidKey && !mockEnabled;
        }
        
        function skipSetup() {
            // Enable mock mode and redirect
            document.getElementById('use-mock').checked = true;
            saveConfiguration();
        }
        
        function saveConfiguration() {
            const data = {
                openai_key: document.getElementById('openai-enable').checked ? document.getElementById('openai-key').value : '',
                anthropic_key: document.getElementById('anthropic-enable').checked ? document.getElementById('anthropic-key').value : '',
                google_key: document.getElementById('google-enable').checked ? document.getElementById('google-key').value : '',
                use_mock: document.getElementById('use-mock').checked
            };
            
            fetch('/api/save-keys', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Configuration saved successfully!');
                    window.location.href = '/execute';
                } else {
                    alert('Failed to save configuration');
                }
            })
            .catch(error => {
                alert('Error saving configuration: ' + error.message);
            });
        }
        
        // Form submission
        document.getElementById('setupForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveConfiguration();
        });
        
        // Enable mock mode checkbox handler
        document.getElementById('use-mock').addEventListener('change', updateSaveButton);
        
        // Initialize existing configuration
        function initializeExistingConfig() {
            // Check OpenAI key
            const openaiKey = document.getElementById('openai-key').value;
            if (openaiKey && openaiKey.trim()) {
                document.getElementById('openai-enable').checked = true;
                toggleProvider('openai');
            }
            
            // Check Anthropic key  
            const anthropicKey = document.getElementById('anthropic-key').value;
            if (anthropicKey && anthropicKey.trim()) {
                document.getElementById('anthropic-enable').checked = true;
                toggleProvider('anthropic');
            }
            
            // Check Google key
            const googleKey = document.getElementById('google-key').value;
            if (googleKey && googleKey.trim()) {
                document.getElementById('google-enable').checked = true;
                toggleProvider('google');
            }
        }
        
        // Initialize
        updateSaveButton();
        initializeExistingConfig();
    </script>
</body>
</html>
